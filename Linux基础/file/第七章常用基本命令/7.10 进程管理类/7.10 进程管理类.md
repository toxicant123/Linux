# 7.10 进程管理类

进程是正在执行的一个程序或命令，每一个进程都是一个运行的实体，都有自己的地址空间，并占用一定的系统资源。

### 7.10.1 ps 查看当前系统进程状态

ps命令来自于英文词组”process status“的缩写，其功能是用于显示当前系统的进程状态。使用ps命令可以查看到进程的所有信息，例如进程的号码、发起者、系统资源使用占比（处理器与内存）、运行状态等等。帮助我们及时的发现哪些进程出现”僵死“或”不可中断“等异常情况。

经常会与kill命令搭配使用来中断和删除不必要的服务进程，避免服务器的资源浪费。

1. 基本语法

ps [参数]

ps aux | grep xxx （功能描述：查看系统中所有进程）

ps -ef | grep xxx （功能描述：可以查看子父进程之间的关系）

2. 选项说明

|       选项       |                    功能                    |
|:--------------:|:----------------------------------------:|
|       a        |              列出带有终端的所有用户的进程              |
|       x        |          列出当前用户的所有进程，包括没有终端的进程           |
|       u        |               面向用户友好的显示风格                |
|       -e       |                  列出所有进程                  |
|       -u       |              列出某个用户关联的所有进程               |
|       -f       |               显示完整格式的进程列表                |
|       -A       |                  显示所有程序                  |
|       c        |           显示每个程序真正的指令名称，而不包含路径           |
|   -C <指令名称>    |          指定执行指令的名称，并列出该指令的程序的状况          |
|       -d       |          显示所有程序，但不包括阶段作业管理员的程序           |
|       e        |           列出程序时，显示每个程序所使用的环境变量           |
|       f        |        用ASCII字符显示树状结构，表达程序间的相互关系         |
|       g        |          显示现行终端机下的所有程序，包括所属组的程序          |
|   -G <群组识别码>   |              列出属于该群组的程序的状况               |
|       h        |                  不显示标题列                  |
|       -H       |            显示树状结构，表示程序间的相互关系             |
|       -j       |             采用工作控制的格式显示程序状况              |
|       -l       |              采用详细的格式来显示程序状况              |
|       L        |                列出栏位的相关信息                 |
|       -m       |                 显示所有的执行绪                 |
|       n        |            以数字来表示USER和WCHAN栏位            |
|       -N       |        显示所有的程序，除了执行ps指令终端机下的程序之外         |
|   -p <程序识别码>   |            指定程序识别码，并列出该程序的状况             |
|       r        |             只列出现行终端机正在执行中的程序             |
|   -s <阶段作业>    |             列出隶属该阶段作业的程序的状况              |
|       s        |             采用程序信号的格式显示程序状况              |
|       S        |            列出程序时，包括已中断的子程序资料             |
|   -t <终端机编号>   |              列出属于该终端机的程序的状况              |
|       -T       |              显示现行终端机下的所有程序               |
|   -U <用户识别码>   |              列出属于该用户的程序的状况               |
|    U <用户名称>    |              列出属于该用户的程序的状况               |
|       v        |             采用虚拟内存的格式显示程序状况              |
|      -V或V      |                  显示版本信息                  |
|      -w或w      |              采用宽阔的格式来显示程序状况              |
|       X        |        采用旧式的Linux i386登陆格式显示程序状况         |
|       -y       | 配合选项”-l”使用时，不显示F(flag)栏位，并以RSS栏位取代ADDR栏位 |
| --cols <每列字符数> |                设置每列的最大字符数                |
|   --headers    |                 重复显示标题列                  |
|     --help     |                   在线帮助                   |
|     --info     |                  显示排错信息                  |
| --lines <显示列数> |                设置显示画面的列数                 |


3. 功能说明

ps aux 显示信息举例：

```text
USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root          1  0.1  0.1 193900  7044 ?        Ss   10:04   0:01 /usr/lib/systemd/systemd --switched-root --system --deserialize 22
root          2  0.0  0.0      0     0 ?        S    10:04   0:00 [kthreadd]
root          3  0.0  0.0      0     0 ?        S    10:04   0:00 [kworker/0:0]
root          4  0.0  0.0      0     0 ?        S<   10:04   0:00 [kworker/0:0H]
root          6  0.0  0.0      0     0 ?        S    10:04   0:00 [ksoftirqd/0]
root          7  0.0  0.0      0     0 ?        S    10:04   0:00 [migration/0]
root          8  0.0  0.0      0     0 ?        S    10:04   0:00 [rcu_bh]
root          9  0.0  0.0      0     0 ?        S    10:04   0:00 [rcu_sched]
root         10  0.0  0.0      0     0 ?        S<   10:04   0:00 [lru-add-drain]
root         11  0.0  0.0      0     0 ?        S    10:04   0:00 [watchdog/0]
root         12  0.0  0.0      0     0 ?        S    10:04   0:00 [watchdog/1]
root         13  0.0  0.0      0     0 ?        S    10:04   0:00 [migration/1]
root         14  0.0  0.0      0     0 ?        S    10:04   0:00 [ksoftirqd/1]
root         16  0.0  0.0      0     0 ?        S<   10:04   0:00 [kworker/1:0H]
root         17  0.0  0.0      0     0 ?        S    10:04   0:00 [watchdog/2]
root         18  0.0  0.0      0     0 ?        S    10:04   0:00 [migration/2]
root         19  0.0  0.0      0     0 ?        S    10:04   0:00 [ksoftirqd/2]
root         20  0.0  0.0      0     0 ?        S    10:04   0:00 [kworker/2:0]
root         21  0.0  0.0      0     0 ?        S<   10:04   0:00 [kworker/2:0H]
root         22  0.0  0.0      0     0 ?        S    10:04   0:00 [watchdog/3]
root         23  0.0  0.0      0     0 ?        S    10:04   0:00 [migration/3]
root         24  0.0  0.0      0     0 ?        S    10:04   0:00 [ksoftirqd/3]
```

* ps aux 显示信息说明
  - USER：该进程是由哪个用户产生的
  - PID：进程的 ID 号
  - %CPU：该进程占用 CPU 资源的百分比，占用越高，进程越耗费资源；
  - %MEM：该进程占用物理内存的百分比，占用越高，进程越耗费资源；
  - VSZ：该进程占用虚拟内存的大小，单位 KB；
  - RSS：该进程占用实际物理内存的大小，单位 KB；
  - TTY：该进程是在哪个终端中运行的。对于 CentOS 来说，tty1 是图形化终端，tty2-tty6 是本地的字符界面终端。pts/0-255 代表虚拟终端。
  - STAT：进程状态。常见的状态有：R：运行状态、S：睡眠状态、T：暂停状态、Z：僵尸状态、s：包含子进程、l：多线程、+：前台显示，位于后台的进程组、D：不可中断、W：进入内存交换（从内核2.6开始无效）、X：死掉的进程、<：高优先级、n：低优先级、L：分页在内存中锁定（对于实时和自定义IO）
  - START：该进程的启动时间
  - TIME：该进程占用 CPU 的运算时间，注意不是系统时间
  - COMMAND：产生此进程的命令名

ps -ef 显示信息举例：

```text
UID         PID   PPID  C STIME TTY          TIME CMD
root          1      0  0 10:04 ?        00:00:01 /usr/lib/systemd/systemd --switched-root --system --deserialize 22
root          2      0  0 10:04 ?        00:00:00 [kthreadd]
root          3      2  0 10:04 ?        00:00:00 [kworker/0:0]
root          4      2  0 10:04 ?        00:00:00 [kworker/0:0H]
root          6      2  0 10:04 ?        00:00:00 [ksoftirqd/0]
root          7      2  0 10:04 ?        00:00:00 [migration/0]
root          8      2  0 10:04 ?        00:00:00 [rcu_bh]
root          9      2  0 10:04 ?        00:00:00 [rcu_sched]
root         10      2  0 10:04 ?        00:00:00 [lru-add-drain]
root         11      2  0 10:04 ?        00:00:00 [watchdog/0]
root         12      2  0 10:04 ?        00:00:00 [watchdog/1]
root         13      2  0 10:04 ?        00:00:00 [migration/1]
root         14      2  0 10:04 ?        00:00:00 [ksoftirqd/1]
root         16      2  0 10:04 ?        00:00:00 [kworker/1:0H]
root         17      2  0 10:04 ?        00:00:00 [watchdog/2]
root         18      2  0 10:04 ?        00:00:00 [migration/2]
root         19      2  0 10:04 ?        00:00:00 [ksoftirqd/2]
root         20      2  0 10:04 ?        00:00:00 [kworker/2:0]
```

* ps -ef 显示信息说明
  - UID：用户 ID
  - PID：进程 ID
  - PPID：父进程 ID
  - C：CPU 用于计算执行优先级的因子。数值越大，表明进程是 CPU 密集型运算，
  - 执行优先级会降低；数值越小，表明进程是 I/O 密集型运算，执行优先级会提高
  - STIME：进程启动的时间
  - TTY：完整的终端名称
  - TIME：CPU 时间
  - CMD：启动进程所用的命令和参数

4. 经验技巧

如果想查看进程的 CPU 占用率和内存占用率，可以使用 aux;

如果想查看进程的父进程 ID 可以使用 ef;

### 7.10.2 kill 终止进程

kill命令的功能是用于杀死（结束）进程，与英文单词的含义相同。Linux系统中如需结束某个进程，既可以使用如service或systemctl的管理命令来结束服务，也可以使用kill命令直接结束进程信息。

如使用kill命令后进程并没有被结束，则可以使用信号9进行强制杀死动作。

1. 基本语法

kill [选项] 进程号 （功能描述：通过进程号杀死进程）

killall 进程名称 （功能描述：通过进程名称杀死进程，也支持通配符，这在系统因负载过大而变得很慢时很有用）

2. 选项说明

| 选项  |       功能        |
|:---:|:---------------:|
| -9  |   表示强迫进程立即停止    |
| -l  |    列出系统支持的信号    |
| -s  |   指定向进程发送的信号    |
| -a  | 不限制命令名和进程号的对应关系 |
| -p  |     不发送任何信号     |


3. 参考实例

杀死浏览器进程

```shell
kill -9 5102
```

通过进程名称杀死进程

```shell
killall firefox
```

列出系统支持的全部信号列表

```shell
kill -l
# 1) SIGHUP	 2) SIGINT	 3) SIGQUIT	 4) SIGILL	 5) SIGTRAP
# 6) SIGABRT	 7) SIGBUS	 8) SIGFPE	 9) SIGKILL	10) SIGUSR1
#11) SIGSEGV	12) SIGUSR2	13) SIGPIPE	14) SIGALRM	15) SIGTERM
#16) SIGSTKFLT	17) SIGCHLD	18) SIGCONT	19) SIGSTOP	20) SIGTSTP
#21) SIGTTIN	22) SIGTTOU	23) SIGURG	24) SIGXCPU	25) SIGXFSZ
#26) SIGVTALRM	27) SIGPROF	28) SIGWINCH	29) SIGIO	30) SIGPWR
#31) SIGSYS	34) SIGRTMIN	35) SIGRTMIN+1	36) SIGRTMIN+2	37) SIGRTMIN+3
#38) SIGRTMIN+4	39) SIGRTMIN+5	40) SIGRTMIN+6	41) SIGRTMIN+7	42) SIGRTMIN+8
#43) SIGRTMIN+9	44) SIGRTMIN+10	45) SIGRTMIN+11	46) SIGRTMIN+12	47) SIGRTMIN+13
#48) SIGRTMIN+14	49) SIGRTMIN+15	50) SIGRTMAX-14	51) SIGRTMAX-13	52) SIGRTMAX-12
#53) SIGRTMAX-11	54) SIGRTMAX-10	55) SIGRTMAX-9	56) SIGRTMAX-8	57) SIGRTMAX-7
#58) SIGRTMAX-6	59) SIGRTMAX-5	60) SIGRTMAX-4	61) SIGRTMAX-3	62) SIGRTMAX-2
#63) SIGRTMAX-1	64) SIGRTMAX	
```

### 7.10.3 pstree 查看进程树

Linux系统中pstree命令的英文全称是“process tree”，即将所有行程以树状图显示，树状图将会以 pid (如果有指定) 或是以 init 这个基本行程为根 (root)，如果有指定使用者 id，则树状图会只显示该使用者所拥有的行程。

1. 基本语法

pstree [选项]

2. 选项说明

| 选项  |              功能              |
|:---:|:----------------------------:|
| -p  |          显示进程的 PID           |
| -u  |          显示进程的所属用户           |
| -a  | 显示每个程序的完整指令，包含路径，参数或是常驻服务的标示 |
| -c  |           不使用精简标示法           |
| -G  |       使用VT100终端机的列绘图字符       |
| -h  |      列出树状图时，特别标明现在执行的程序      |

3. 参考实例

显示进程 pid

```shell
pstree -p
```

显示进程所属用户

```shell
pstree -u
```

显示所有进程的所有详细信息，遇到相同的进程名可以压缩显示

```shell
pstree  -a
```

### 7.10.4 top 实时监控系统进程状态

top命令的功能是用于实时显示系统运行状态，包含处理器、内存、服务、进程等重要资源信息。运维工程师们常常会把top命令比作是“加强版的Windows任务管理器”，因为除了能看到常规的服务进程信息以外，还能够对处理器和内存的负载情况一目了然，实时感知系统全局的运行状态，非常适合作为接手服务器后执行的第一条命令。

1. 基本命令

top [选项]

2. 选项说明

|   选项   |         功能         |
|:------:|:------------------:|
| -d <秒> |     改变显示的更新速度      |
|   -c   |       切换显示模式       |
|   -s   |   安全模式，不允许交互式指令    |
|   -i   |   不显示任何闲置或僵死的行程    |
|   -n   | 设定显示的总次数，完成后将会自动退出 |
|   -b   |   批处理模式，不进行交互式显示   |

3. 操作说明

在以下页面：

```text
top - 10:45:04 up 41 min,  2 users,  load average: 0.00, 0.01, 0.03
Tasks: 216 total,   1 running, 215 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  4026160 total,  1816600 free,   888376 used,  1321184 buff/cache
KiB Swap:  4194300 total,  4194300 free,        0 used.  2872484 avail Mem 

   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                              
     1 root      20   0  193900   7044   4196 S   0.0  0.2   0:01.35 systemd                                                              
     2 root      20   0       0      0      0 S   0.0  0.0   0:00.00 kthreadd                                                             
     3 root      20   0       0      0      0 S   0.0  0.0   0:00.18 kworker/0:0                                                          
     4 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 kworker/0:0H                                                         
     6 root      20   0       0      0      0 S   0.0  0.0   0:00.00 ksoftirqd/0                                                          
     7 root      rt   0       0      0      0 S   0.0  0.0   0:00.02 migration/0                                                          
     8 root      20   0       0      0      0 S   0.0  0.0   0:00.00 rcu_bh                                                               
     9 root      20   0       0      0      0 S   0.0  0.0   0:00.14 rcu_sched                                                            
    10 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 lru-add-drain                                                        
    11 root      rt   0       0      0      0 S   0.0  0.0   0:00.01 watchdog/0                                                           
    12 root      rt   0       0      0      0 S   0.0  0.0   0:00.00 watchdog/1                                                           
    13 root      rt   0       0      0      0 S   0.0  0.0   0:00.02 migration/1                                                          
    14 root      20   0       0      0      0 S   0.0  0.0   0:00.01 ksoftirqd/1                                                          
    16 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 kworker/1:0H                                                         
    17 root      rt   0       0      0      0 S   0.0  0.0   0:00.00 watchdog/2                       
```

输入以下指令：

| 操作  |         功能         |
|:---:|:------------------:|
|  P  | 以 CPU 使用率排序，默认就是此项 |
|  M  |     以内存的使用率排序      |
|  N  |      以 PID 排序      |
|  q  |       退出 top       |

4. 查询结果字段解释

查询结果举例可见上文

第一行信息为任务队列信息

|               内容               |                             说明                              |
|:------------------------------:|:-----------------------------------------------------------:|
|            12:26:46            |                           系统当前时间                            |
|        up 1 day, 13:32         |               系统的运行时间，本机已经运行 1 天 13 小时 32 分钟                |
|            2 users             |                          当前登录了两个用户                          |
| load average: 0.00, 0.00, 0.00 | 系统在之前 1 分钟，5 分钟，15 分钟的平均负载。一般认为小于 0.7 时，负载较小。如果大于1，系统已经超出负荷 |

第二行为进程信息

|       内容        |           说明           |
|:---------------:|:----------------------:|
| Tasks: 95 total |        系统中的进程总数        |
|    1 running    |        正在运行的进程数        |
|   94 sleeping   |         睡眠的进程          |
|    0 stopped    |        正在停止的进程         |
|    0 zombie     | 僵尸进程。如果不是 0，需要手工检查僵尸进程 |

第三行为 CPU 信息

|       内容       |                                  说明                                  |
|:--------------:|:--------------------------------------------------------------------:|
| Cpu(s): 0.1%us |                           用户模式占用的 CPU 百分比                            |
|     0.1%sy     |                           系统模式占用的 CPU 百分比                            |
|     0.0%ni     |                        改变过优先级的用户进程占用的 CPU 百分比                        |
|    99.7%id     |                           空闲 CPU 的 CPU 百分比                           |
|     0.1%wa     |                        等待输入/输出的进程的占用 CPU 百分比                         |
|     0.0%hi     |                          硬中断请求服务占用的 CPU 百分比                          |
|     0.1%si     |                          软中断请求服务占用的 CPU 百分比                          |
|     0.0%st     |        st（Steal time）虚拟时间百分比。就是当有虚拟机时，虚拟 CPU 等待实际 CPU 的时间百分比         |

第四行为物理内存信息

|         内容         |                          说明                          |
|:------------------:|:----------------------------------------------------:|
| Mem: 625344k total |                    物理内存的总量，单位 KB                     |
|    571504k used    |                     已经使用的物理内存数量                      |
|    53840k free     | 空闲的物理内存数量，我们使用的是虚拟机，总共只分配了 628MB 内存，所以只有 53MB 的空闲内存了 |
|   65800k buffers   |                      作为缓冲的内存数量                       |

第五行为交换分区（swap）信息

|         内容          |       说明       |
|:-------------------:|:--------------:|
| Swap: 524280k total | 交换分区（虚拟内存）的总大小 |
|       0k used       |  已经使用的交互分区的大小  |
|    524280k free     |   空闲交换分区的大小    |
|   409280k cached    |  作为缓存的交互分区的大小  |

### 7.10.5 netstat 显示网络状态和端口占用信息

netstat命令来自于英文词组”network statistics“的缩写，其功能是用于显示各种网络相关信息，例如网络连接状态、路由表信息、接口状态、NAT、多播成员等等。

netstat命令不仅应用于Linux系统，而且在Windows XP、Windows 7、Windows 10及Windows 11中均已默认支持，并且可用参数也相同，有经验的运维人员可以直接上手。

1. 基本语法

netstat -anp | grep 进程号 （功能描述：查看该进程网络信息）

netstat –nlp | grep 端口号 （功能描述：查看网络端口号占用情况）

2. 选项说明

| 选项  |           功能            |
|:---:|:-----------------------:|
| -a  |     显示所有连线中的Socket      |
| -p  | 显示正在使用Socket的程序识别码和程序名称 |
| -l  |       仅列出在监听的服务状态       |
| -t  |     显示TCP传输协议的连线状况      |
| -u  |     显示UDP传输协议的连线状况      |
| -i  |       显示网络界面信息表单        |
| -r  |         显示路由表信息         |
| -n  |    直接使用IP地址，不通过域名服务器    |

3. 参考实例

通过进程号查看sshd进程的网络信息

```shell
netstat -anp | grep sshd
```

查看某端口号是否被占用

```shell
netstat -nltp | grep 22
```

显示网卡当前状态信息

```shell
netstat -i 
```

### 7.10.6 uptime 查看系统负载

Linux系统中的uptime命令主要用于获取主机运行时间和查询Linux系统负载等信息。

uptime命令可以显示系统已经运行了多长时间，信息显示依次为：现在时间、系统已经运行了多长时间、目前有多少登录用户、系统在过去的1分钟、5分钟和15分钟内的平均负载。 uptime命令用法十分简单，直接输入uptime即可查看系统负载情况。

1. 基本语法

uptime [参数]

2. 常用参数

| 参数  |                功能                |
|:---:|:--------------------------------:|
| -p  |        以漂亮的格式显示机器正常运行的时间         |
| -s  | 系统自开始运行时间，格式为yyyy-mm-dd hh:mm:ss |
| -h  |              显示帮助信息              |

3. 参考实例

显示当前系统运行负载情况

```shell
uptime 
#15:23:22 up 2 days,  5:13,  3 users,  load average: 0.12, 0.04, 0.05
```

使用-p参数显示机器正常运行的时间

```shell
uptime -p
#up 2 days, 5 hours, 15 minutes
```

### 7.10.7 nice 调整进程的优先级

nice是用来调整进程的执行优先级的，nice命令表示新执行的命令即给予新的nice值。系统的后台工作中，某些比较不重要的进程在运行，例如备份，由于备份工作相当耗系统资源，这个时候就可以调大备份命令的nice值，可以使系统资源更合理使用。

1. 基本语法

nice [参数] [命令]

2. 常用参数

| 参数  |        功能         |
|:---:|:-----------------:|
| -n  | 后面接一个数值，范围在-20~19 |

3. 参考实例

用root给一个nice值为-5，用于执行vi，并查看该进程

```shell
nice -n -5 vi &
```

### 7.10.8 pidof 返回运行程序的进程ID

pidof命令用于检索指定的命令，返回相应的进程ID。其中program是一个或多个命令或进程的名字。当需要终止某个进程时，传统的做法是利用ps命令列出所有的进程，使用grep命令选出目标进程，然后使用kill命令终止进程。

利用pidof命令，可以省略ps与grep组合命令，直接把指定命令的进程ID写入到标准输出。

1. 基本语法

pidof [参数]

2. 常用参数

| 参数  |           功能            |
|:---:|:-----------------------:|
| -s  | 当系统中存在多个同名进程时，仅返回一个进程ID |
| -c  | 仅返回当前正在运行且具有同一根目录的进程PID |
| -x  |   返回指定运行脚本的shell进程PID   |
| -o  |      忽略具有指定进程ID的进程      |

3. 参考实例

返回crond守护进程的PID

```shell
pidof crond
```

返回Apache服务器守护进程httpd

```shell
pidof httpd
```