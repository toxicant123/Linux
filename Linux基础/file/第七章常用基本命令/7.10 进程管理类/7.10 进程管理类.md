# 7.10 进程管理类

进程是正在执行的一个程序或命令，每一个进程都是一个运行的实体，都有自己的地址空间，并占用一定的系统资源。

### 7.10.1 ps 查看当前系统进程状态

ps: process status 进程状态

1. 基本语法

ps aux | grep xxx （功能描述：查看系统中所有进程）

ps -ef | grep xxx （功能描述：可以查看子父进程之间的关系）

2. 选项说明

| 选项  |          功能           |
|:---:|:---------------------:|
|  a  |    列出带有终端的所有用户的进程     |
|  x  | 列出当前用户的所有进程，包括没有终端的进程 |
|  u  |      面向用户友好的显示风格      |
| -e  |        列出所有进程         |
| -u  |     列出某个用户关联的所有进程     |
| -f  |      显示完整格式的进程列表      |

3. 功能说明

ps aux 显示信息举例：

```text
USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root          1  0.1  0.1 193900  7044 ?        Ss   10:04   0:01 /usr/lib/systemd/systemd --switched-root --system --deserialize 22
root          2  0.0  0.0      0     0 ?        S    10:04   0:00 [kthreadd]
root          3  0.0  0.0      0     0 ?        S    10:04   0:00 [kworker/0:0]
root          4  0.0  0.0      0     0 ?        S<   10:04   0:00 [kworker/0:0H]
root          6  0.0  0.0      0     0 ?        S    10:04   0:00 [ksoftirqd/0]
root          7  0.0  0.0      0     0 ?        S    10:04   0:00 [migration/0]
root          8  0.0  0.0      0     0 ?        S    10:04   0:00 [rcu_bh]
root          9  0.0  0.0      0     0 ?        S    10:04   0:00 [rcu_sched]
root         10  0.0  0.0      0     0 ?        S<   10:04   0:00 [lru-add-drain]
root         11  0.0  0.0      0     0 ?        S    10:04   0:00 [watchdog/0]
root         12  0.0  0.0      0     0 ?        S    10:04   0:00 [watchdog/1]
root         13  0.0  0.0      0     0 ?        S    10:04   0:00 [migration/1]
root         14  0.0  0.0      0     0 ?        S    10:04   0:00 [ksoftirqd/1]
root         16  0.0  0.0      0     0 ?        S<   10:04   0:00 [kworker/1:0H]
root         17  0.0  0.0      0     0 ?        S    10:04   0:00 [watchdog/2]
root         18  0.0  0.0      0     0 ?        S    10:04   0:00 [migration/2]
root         19  0.0  0.0      0     0 ?        S    10:04   0:00 [ksoftirqd/2]
root         20  0.0  0.0      0     0 ?        S    10:04   0:00 [kworker/2:0]
root         21  0.0  0.0      0     0 ?        S<   10:04   0:00 [kworker/2:0H]
root         22  0.0  0.0      0     0 ?        S    10:04   0:00 [watchdog/3]
root         23  0.0  0.0      0     0 ?        S    10:04   0:00 [migration/3]
root         24  0.0  0.0      0     0 ?        S    10:04   0:00 [ksoftirqd/3]
```

* ps aux 显示信息说明
  - USER：该进程是由哪个用户产生的
  - PID：进程的 ID 号
  - %CPU：该进程占用 CPU 资源的百分比，占用越高，进程越耗费资源；
  - %MEM：该进程占用物理内存的百分比，占用越高，进程越耗费资源；
  - VSZ：该进程占用虚拟内存的大小，单位 KB；
  - RSS：该进程占用实际物理内存的大小，单位 KB；
  - TTY：该进程是在哪个终端中运行的。对于 CentOS 来说，tty1 是图形化终端，tty2-tty6 是本地的字符界面终端。pts/0-255 代表虚拟终端。
  - STAT：进程状态。常见的状态有：R：运行状态、S：睡眠状态、T：暂停状态、Z：僵尸状态、s：包含子进程、l：多线程、+：前台显示，位于后台的进程组、D：不可中断、W：进入内存交换（从内核2.6开始无效）、X：死掉的进程、<：高优先级、n：低优先级、L：分页在内存中锁定（对于实时和自定义IO）
  - START：该进程的启动时间
  - TIME：该进程占用 CPU 的运算时间，注意不是系统时间
  - COMMAND：产生此进程的命令名

ps -ef 显示信息举例：

```text
UID         PID   PPID  C STIME TTY          TIME CMD
root          1      0  0 10:04 ?        00:00:01 /usr/lib/systemd/systemd --switched-root --system --deserialize 22
root          2      0  0 10:04 ?        00:00:00 [kthreadd]
root          3      2  0 10:04 ?        00:00:00 [kworker/0:0]
root          4      2  0 10:04 ?        00:00:00 [kworker/0:0H]
root          6      2  0 10:04 ?        00:00:00 [ksoftirqd/0]
root          7      2  0 10:04 ?        00:00:00 [migration/0]
root          8      2  0 10:04 ?        00:00:00 [rcu_bh]
root          9      2  0 10:04 ?        00:00:00 [rcu_sched]
root         10      2  0 10:04 ?        00:00:00 [lru-add-drain]
root         11      2  0 10:04 ?        00:00:00 [watchdog/0]
root         12      2  0 10:04 ?        00:00:00 [watchdog/1]
root         13      2  0 10:04 ?        00:00:00 [migration/1]
root         14      2  0 10:04 ?        00:00:00 [ksoftirqd/1]
root         16      2  0 10:04 ?        00:00:00 [kworker/1:0H]
root         17      2  0 10:04 ?        00:00:00 [watchdog/2]
root         18      2  0 10:04 ?        00:00:00 [migration/2]
root         19      2  0 10:04 ?        00:00:00 [ksoftirqd/2]
root         20      2  0 10:04 ?        00:00:00 [kworker/2:0]
```

* ps -ef 显示信息说明
  - UID：用户 ID
  - PID：进程 ID
  - PPID：父进程 ID
  - C：CPU 用于计算执行优先级的因子。数值越大，表明进程是 CPU 密集型运算，
  - 执行优先级会降低；数值越小，表明进程是 I/O 密集型运算，执行优先级会提高
  - STIME：进程启动的时间
  - TTY：完整的终端名称
  - TIME：CPU 时间
  - CMD：启动进程所用的命令和参数

4. 经验技巧

如果想查看进程的 CPU 占用率和内存占用率，可以使用 aux;

如果想查看进程的父进程 ID 可以使用 ef;

### 7.10.2 kill 终止进程

1. 基本语法

kill [选项] 进程号 （功能描述：通过进程号杀死进程）

killall 进程名称 （功能描述：通过进程名称杀死进程，也支持通配符，这在系统因负载过大而变得很慢时很有用）

2. 选项说明

| 选项  |     功能     |
|:---:|:----------:|
| -9  | 表示强迫进程立即停止 |

3. 案例实操

杀死浏览器进程

```shell
kill -9 5102
```

通过进程名称杀死进程

```shell
killall firefox
```

### 7.10.3 pstree 查看进程树

1. 基本语法

pstree [选项]

2. 选项说明

| 选项  |    功能     |
|:---:|:---------:|
| -p  | 显示进程的 PID |
| -u  | 显示进程的所属用户 |

3. 案例实操

显示进程 pid

```shell
pstree -p
```

显示进程所属用户

```shell
pstree -u
```

### 7.10.4 top 实时监控系统进程状态

1. 基本命令

top [选项]

2. 选项说明

|  选项   |                      功能                       |
|:-----:|:---------------------------------------------:|
| -d 秒数 | 指定 top 命令每隔几秒更新。默认是 3 秒在 top 命令的交互模式当中可以执行的命令 |
|  -i   |              使 top 不显示任何闲置或者僵死进程              |
|  -p   |           通过指定监控进程 ID 来仅仅监控某个进程的状态            |

3. 操作说明

在以下页面：

```text
top - 10:45:04 up 41 min,  2 users,  load average: 0.00, 0.01, 0.03
Tasks: 216 total,   1 running, 215 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  4026160 total,  1816600 free,   888376 used,  1321184 buff/cache
KiB Swap:  4194300 total,  4194300 free,        0 used.  2872484 avail Mem 

   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                              
     1 root      20   0  193900   7044   4196 S   0.0  0.2   0:01.35 systemd                                                              
     2 root      20   0       0      0      0 S   0.0  0.0   0:00.00 kthreadd                                                             
     3 root      20   0       0      0      0 S   0.0  0.0   0:00.18 kworker/0:0                                                          
     4 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 kworker/0:0H                                                         
     6 root      20   0       0      0      0 S   0.0  0.0   0:00.00 ksoftirqd/0                                                          
     7 root      rt   0       0      0      0 S   0.0  0.0   0:00.02 migration/0                                                          
     8 root      20   0       0      0      0 S   0.0  0.0   0:00.00 rcu_bh                                                               
     9 root      20   0       0      0      0 S   0.0  0.0   0:00.14 rcu_sched                                                            
    10 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 lru-add-drain                                                        
    11 root      rt   0       0      0      0 S   0.0  0.0   0:00.01 watchdog/0                                                           
    12 root      rt   0       0      0      0 S   0.0  0.0   0:00.00 watchdog/1                                                           
    13 root      rt   0       0      0      0 S   0.0  0.0   0:00.02 migration/1                                                          
    14 root      20   0       0      0      0 S   0.0  0.0   0:00.01 ksoftirqd/1                                                          
    16 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 kworker/1:0H                                                         
    17 root      rt   0       0      0      0 S   0.0  0.0   0:00.00 watchdog/2                       
```

输入以下指令：

| 操作  |         功能         |
|:---:|:------------------:|
|  P  | 以 CPU 使用率排序，默认就是此项 |
|  M  |     以内存的使用率排序      |
|  N  |      以 PID 排序      |
|  q  |       退出 top       |

4. 查询结果字段解释

查询结果举例可见上文

第一行信息为任务队列信息

|               内容               |                             说明                              |
|:------------------------------:|:-----------------------------------------------------------:|
|            12:26:46            |                           系统当前时间                            |
|        up 1 day, 13:32         |               系统的运行时间，本机已经运行 1 天 13 小时 32 分钟                |
|            2 users             |                          当前登录了两个用户                          |
| load average: 0.00, 0.00, 0.00 | 系统在之前 1 分钟，5 分钟，15 分钟的平均负载。一般认为小于 0.7 时，负载较小。如果大于1，系统已经超出负荷 |

第二行为进程信息

|       内容        |           说明           |
|:---------------:|:----------------------:|
| Tasks: 95 total |        系统中的进程总数        |
|    1 running    |        正在运行的进程数        |
|   94 sleeping   |         睡眠的进程          |
|    0 stopped    |        正在停止的进程         |
|    0 zombie     | 僵尸进程。如果不是 0，需要手工检查僵尸进程 |

第三行为 CPU 信息

|       内容       |                                  说明                                  |
|:--------------:|:--------------------------------------------------------------------:|
| Cpu(s): 0.1%us |                           用户模式占用的 CPU 百分比                            |
|     0.1%sy     |                           系统模式占用的 CPU 百分比                            |
|     0.0%ni     |                        改变过优先级的用户进程占用的 CPU 百分比                        |
|    99.7%id     |                           空闲 CPU 的 CPU 百分比                           |
|     0.1%wa     |                        等待输入/输出的进程的占用 CPU 百分比                         |
|     0.0%hi     |                          硬中断请求服务占用的 CPU 百分比                          |
|     0.1%si     |                          软中断请求服务占用的 CPU 百分比                          |
|     0.0%st     |        st（Steal time）虚拟时间百分比。就是当有虚拟机时，虚拟 CPU 等待实际 CPU 的时间百分比         |

第四行为物理内存信息

|         内容         |                          说明                          |
|:------------------:|:----------------------------------------------------:|
| Mem: 625344k total |                    物理内存的总量，单位 KB                     |
|    571504k used    |                     已经使用的物理内存数量                      |
|    53840k free     | 空闲的物理内存数量，我们使用的是虚拟机，总共只分配了 628MB 内存，所以只有 53MB 的空闲内存了 |
|   65800k buffers   |                      作为缓冲的内存数量                       |

第五行为交换分区（swap）信息

|         内容          |       说明       |
|:-------------------:|:--------------:|
| Swap: 524280k total | 交换分区（虚拟内存）的总大小 |
|       0k used       |  已经使用的交互分区的大小  |
|    524280k free     |   空闲交换分区的大小    |
|   409280k cached    |  作为缓存的交互分区的大小  |

### 7.10.5 netstat 显示网络状态和端口占用信息

1. 基本语法

netstat -anp | grep 进程号 （功能描述：查看该进程网络信息）

netstat –nlp | grep 端口号 （功能描述：查看网络端口号占用情况）

2. 选项说明

| 选项  |                功能                |
|:---:|:--------------------------------:|
| -a  | 显示所有正在监听（listen）和未监听的套接字（socket） |
| -n  |       拒绝显示别名，能显示数字的全部转化成数字       |
| -l  |           仅列出在监听的服务状态            |
| -p  |           表示显示哪个进程在调用            |

3. 案例实操

通过进程号查看sshd进程的网络信息

```shell
netstat -anp | grep sshd
```

查看某端口号是否被占用

```shell
netstat -nltp | grep 22
```